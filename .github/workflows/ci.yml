name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: [self-hosted, linux, arm64, blackroad]
    steps:
      - uses: actions/checkout@v4
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning

  terraform:
    name: Terraform Validate
    runs-on: [self-hosted, linux, arm64, blackroad]
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
      - name: Format check
        run: |
          find . -name "*.tf" -exec dirname {} \; | sort -u | while read dir; do
            terraform -chdir="$dir" fmt -check -diff 2>/dev/null || echo "fmt: $dir"
          done
      - name: Init + Validate
        run: |
          find . -name "*.tf" -exec dirname {} \; | sort -u | while read dir; do
            echo "→ Validating $dir"
            terraform -chdir="$dir" init -backend=false -no-color 2>/dev/null || true
            terraform -chdir="$dir" validate -no-color 2>/dev/null && echo "✅ $dir valid" || echo "⚠️ $dir needs attention"
          done

  yaml-lint:
    name: YAML Lint
    runs-on: [self-hosted, linux, arm64, blackroad]
    steps:
      - uses: actions/checkout@v4
      - name: Lint YAML files
        run: |
          pip install yamllint -q
          find . -name "*.yml" -o -name "*.yaml" | grep -v '.git' | xargs yamllint -d relaxed 2>/dev/null || true
          echo "✅ YAML lint done"
