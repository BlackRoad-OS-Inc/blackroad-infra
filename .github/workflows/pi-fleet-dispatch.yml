name: Pi Fleet â€” Handle Repo Dispatch

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Receives repository_dispatch events from all 17 orgs.
#  Runs the actual deploy ON the Pi (self-hosted runner).
#  GitHub pushes the job to Pi over HTTPS â€” Pi does the work.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

on:
  repository_dispatch:
    types: [repo-push]

jobs:
  deploy-on-pi:
    name: "Deploy on Pi â€” ${{ github.event.client_payload.repo }}"
    runs-on: [self-hosted, pi-fleet, primary]
    steps:

      - name: Log incoming dispatch
        run: |
          echo "ðŸ“¦ Dispatch from: ${{ github.event.client_payload.repo }}"
          echo "ðŸŒ¿ Ref: ${{ github.event.client_payload.ref }}"
          echo "ðŸ”‘ SHA: ${{ github.event.client_payload.sha }}"
          echo "ðŸ‘¤ Actor: ${{ github.event.client_payload.actor }}"

      - uses: actions/checkout@v6
        with:
          repository: ${{ github.event.client_payload.repo }}
          ref: ${{ github.event.client_payload.sha }}
          token: ${{ secrets.ORG_PAT }}
          path: repo

      - name: Detect project type + deploy
        run: |
          cd repo

          # â”€â”€ Node.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ -f package.json ]; then
            echo "â†’ Node.js project detected"
            npm install --prefer-offline --silent
            npm run build --if-present
            # Restart via PM2 if running
            pm2_name=$(cat package.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('name','app'))" 2>/dev/null || echo "app")
            pm2 restart "$pm2_name" 2>/dev/null || pm2 start npm --name "$pm2_name" -- start 2>/dev/null || true
            echo "âœ“ Node deploy complete"
          fi

          # â”€â”€ Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            echo "â†’ Python project detected"
            pip install -q -r requirements.txt 2>/dev/null || pip install -q . 2>/dev/null || true
            # Restart service if systemd unit exists
            svc_name=$(basename "${{ github.event.client_payload.repo }}")
            sudo systemctl restart "$svc_name" 2>/dev/null || true
            echo "âœ“ Python deploy complete"
          fi

          # â”€â”€ Static / HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ -f index.html ] && [ ! -f package.json ]; then
            echo "â†’ Static site detected"
            dest="/var/www/${{ github.event.client_payload.repo }}"
            sudo mkdir -p "$dest"
            sudo cp -r . "$dest/"
            sudo nginx -t && sudo systemctl reload nginx
            echo "âœ“ Static deploy complete"
          fi

          # â”€â”€ Shell scripts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ -f br ] || [ -f install.sh ]; then
            chmod +x br install.sh 2>/dev/null || true
            echo "âœ“ Scripts ready"
          fi

      - name: Report back to GitHub
        if: always()
        run: |
          echo "## Pi Fleet Deploy â€” ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repo:** ${{ github.event.client_payload.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA:** ${{ github.event.client_payload.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Host:** $(hostname) ($(hostname -I | awk '{print $1}'))" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
