# ============================================================
#  BlackRoad — All domains through Pi fleet
#  One map routes every subdomain to the right backend port.
#  cloudflared → nginx :80 → upstream services
# ============================================================

# ── Backend upstream pool ─────────────────────────────────────
upstream agents {
    server 127.0.0.1:8080;
    server 192.168.4.38:8080 backup;
    keepalive 32;
}
upstream api {
    server 127.0.0.1:3000;
    server 192.168.4.38:3000 backup;
    keepalive 32;
}
upstream ollama {
    server 127.0.0.1:11434;
    server 192.168.4.38:11434 backup;
    server 192.168.4.99:11434 backup;
    keepalive 16;
}
upstream gateway {
    server 127.0.0.1:8787;
    keepalive 16;
}
upstream dashboard {
    server 127.0.0.1:4000;
    server 192.168.4.38:4000 backup;
    keepalive 8;
}
upstream docs {
    server 127.0.0.1:3001;
    keepalive 8;
}
upstream stats {
    server 127.0.0.1:8090;   # pi-stats-server.py
    keepalive 4;
}

# ── WebSocket upgrade helper ──────────────────────────────────
map $http_upgrade $connection_upgrade {
    default  upgrade;
    ''       close;
}

# ── Route hostname → named upstream ──────────────────────────
map $host $backend {
    # Agents / real-time
    agents.blackroad.io          agents;
    ws.blackroad.io              agents;
    ws.lucidia.earth             agents;

    # Ollama LLM
    ollama.blackroad.io          ollama;
    llm.blackroad.io             ollama;
    model.blackroad.io           ollama;

    # Gateway (tokenless AI proxy)
    gateway.blackroad.io         gateway;
    gateway.lucidia.earth        gateway;

    # API
    api.blackroad.io             api;
    api.lucidia.earth            api;

    # Docs
    docs.blackroad.io            docs;
    docs.lucidia.earth           docs;
    guide.blackroad.io           docs;

    # Stats / health (iOS app hits this)
    health.blackroad.io          stats;
    stats.blackroad.io           stats;

    # Everything else → dashboard/operator panel
    default                      dashboard;
}

# ── Route hostname → proxy timeouts (streaming = long) ───────
map $host $proxy_timeout {
    ollama.blackroad.io          600s;
    llm.blackroad.io             600s;
    model.blackroad.io           600s;
    agents.blackroad.io          300s;
    ws.blackroad.io              300s;
    ws.lucidia.earth             300s;
    default                      120s;
}

# ── Shared proxy params (included in each server block) ──────
#    (inline below — nginx doesn't support include in map context)

# ============================================================
#  Single wildcard server — handles ALL domains routed here
# ============================================================
server {
    listen 80 default_server;
    server_name _;       # matches everything cloudflared sends

    # ── Real IP from Cloudflare ──────────────────────────────
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    real_ip_header CF-Connecting-IP;

    # ── Gzip ─────────────────────────────────────────────────
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml;

    # ── Internal health ──────────────────────────────────────
    location = /_br/health {
        access_log off;
        return 200 '{"status":"ok","tier":"pi-fleet"}';
        add_header Content-Type application/json;
    }
    location = /health {
        access_log off;
        return 200 '{"status":"ok","tier":"pi-fleet"}';
        add_header Content-Type application/json;
    }

    # ── Proxy to mapped upstream ─────────────────────────────
    location / {
        proxy_pass         http://$backend;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   CF-Ray            $http_cf_ray;

        # WebSocket
        proxy_http_version 1.1;
        proxy_set_header   Upgrade    $http_upgrade;
        proxy_set_header   Connection $connection_upgrade;

        # Timeouts (streaming-aware)
        proxy_read_timeout  $proxy_timeout;
        proxy_send_timeout  $proxy_timeout;
        proxy_connect_timeout 5s;

        # Streaming: disable buffering for Ollama/SSE
        proxy_buffering           off;
        proxy_cache               off;
        proxy_request_buffering   off;

        # Error handling
        proxy_next_upstream error timeout http_502 http_503;
        proxy_intercept_errors off;
    }
}
